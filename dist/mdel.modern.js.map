{"version":3,"file":"mdel.modern.js","sources":["../src/utils/helper.ts","../src/utils/observe.ts","../src/module/store.ts","../src/type.ts","../src/index.ts","../src/module/model.ts"],"sourcesContent":["/**\n * 判断是否是对象\n * @param data {*} 待检测的数据\n * @return {boolean}\n */\nexport function isObject(data: any): boolean {\n    return Object.prototype.toString.call(data) === '[object Object]';\n}\n\n/**\n * 抛出异常\n * @param message {string} 错误信息\n * @param name {string} 标识\n */\nexport function throwError(message: string, name = 'mdel'): never {\n    throw new Error(name + ':' + message)\n}\n\n/**\n * 绑定this\n * @param target {Object} 目标\n * @param thisArg {*} this值\n * @return {Object}\n */\nexport function bindThis<T extends {\n    [index: string]: (...args: any[]) => any\n}>(target: T, thisArg: any): T {\n    const result = {} as T;\n\n    Object.keys(target).forEach((key) => {\n        (result as any)[key] = target[key].bind(thisArg)\n    });\n\n    return result;\n}\n","import {Store, StoreData, StoreObserver} from \"../type\";\n\nexport class Observable {\n    observes: StoreObserver<any>[] = [];\n\n    addObserver(observer: StoreObserver<any>) {\n        this.removeObserver(observer);\n        this.observes.push(observer);\n    }\n\n    removeObserver(observer: StoreObserver<any>) {\n        this.observes = this.observes.filter(item => item !== observer);\n    }\n\n    notifyObservers(store: Store<any>, data: StoreData) {\n        const observes = [...this.observes];\n\n        observes.forEach(observer => observer.call(store, data));\n    }\n}\n","import {isObject, throwError} from \"../utils/helper\";\nimport {ConvertData, PickModelData, Store, StoreCore, StoreData} from \"../type\";\nimport {Observable} from \"../utils/observe\";\n\nfunction convertData<S extends Store<any>>(store: S): ConvertData<S> {\n  const data = getStoreData(store as any);\n\n  function findData(target: any) {\n    if (target && target.core && target.core.isStore) {\n      // @ts-ignore\n      return convertData(target);\n    } else if (isObject(target)) {\n      return Object.keys(target).reduce((previousValue, currentValue) => {\n        previousValue[currentValue] = findData(target[currentValue]);\n\n        return previousValue;\n      }, {});\n    } else if (Array.isArray(target)) {\n      return target.map(item => findData(item));\n    }\n\n    return target;\n  }\n\n  return findData(data);\n}\n\nexport function checkData(data: any) {\n    if (!isObject(data)) {\n        throwError('data is not a object');\n    }\n\n    if (data.core) {\n        throwError('data cannot have core property');\n    }\n\n    if (data.actions) {\n        throwError('data cannot have core property');\n    }\n}\n\nexport function getStoreData<D extends StoreData, S extends Store<D>>(store: S): PickModelData<D> {\n    const {core, actions, ...data} = store;\n\n    return data as PickModelData<D>;\n}\n\nexport class BaseStore implements Store<{}> {\n  core: { __observable: Observable } & StoreCore<any, any> = {\n    isStore: true,\n    setData: (data) => {\n      checkData(data);\n\n      const previousData = getStoreData(this);\n      (<any>Object).assign(this, data)\n      this.core.__observable.notifyObservers(this, previousData);\n    },\n    convertData: () => {\n      return convertData(this);\n    },\n    observe: (observer) => {\n      this.core.__observable.addObserver(observer);\n      return () => this.core.__observable.removeObserver(observer);\n    },\n    //需子类实现\n    resetData: () => {\n    },\n    //需子类实现\n    baseActions: {},\n\n    __observable: new Observable()\n  }\n  actions: {}\n}\n","export type StoreData = object;\nexport  type StoreObserver<D extends StoreData> = (previousData: D) => void;\nexport  type StoreUnobserve = () => void;\nexport  type StoreObserve<D extends StoreData> = (observer: StoreObserver<D>) => StoreUnobserve;\nexport  type StoreActions = {\n  init?: (...args: any[]) => void;\n  input?: (...args: any[]) => void;\n  output?: () => any;\n} & {\n  [index in PropertyKey]: (...args: any[]) => any;\n};\nexport  type StoreCore<D extends StoreData, BA extends StoreActions> = {\n  isStore: boolean;\n  setData: (data: Partial<D>) => void;\n  convertData: () => ConvertData<D>;\n  resetData: () => void;\n  observe: StoreObserve<D>;\n  baseActions: BA;\n};\nexport  type Store<D extends StoreData, A extends StoreActions = {}, BA extends StoreActions = {}> = {\n  core: StoreCore<D, BA>;\n} & {\n  actions: A;\n} & D;\nexport  type Model<D extends StoreData, A extends StoreActions = {}, BA extends StoreActions = {}> = {\n  new(): Store<D, A, BA>;\n  isModel: boolean;\n};\nexport  type PickModelStore<M> = M extends new (...args: any[]) => infer P ? P : any;\nexport  type PickModelData<M> = M extends Model<infer D, infer A> ? D : {};\nexport  type PickModelActions<M> = M extends Model<infer D, infer A> ? A : {};\nexport  type PickStoreData<S> = S extends Store<infer D, infer A> ? D : {};\nexport  type PickStoreActions<S> = S extends Store<infer D, infer A> ? A : {};\nexport  type CreateModelInitiator<D extends StoreData, A extends StoreActions = {}, B extends Model<StoreData> | null = null> = {\n  single?: boolean;\n  base?: B;\n  data: () => D;\n  actions?: A & ThisType<Store<D & PickModelData<B>, A & PickModelActions<B>, PickModelActions<B>>>;\n};\nexport  type CreateModel = <D extends StoreData, A extends StoreActions = {}, B extends Model<StoreData> | null = null>(initiator: CreateModelInitiator<D, A, B>) => Model<D & PickModelData<B>, A & PickModelActions<B>, PickModelActions<B>>;\nexport  type ConvertData<D> = ConvertArrayData<ConvertObjectData<ConvertStoreData<D>>>;\ntype ConvertStoreData<S> = S extends Store<infer D> ? ConvertData<D> : S;\ntype ConvertObjectData<O> = O extends object ? {\n  [K in keyof O]: ConvertData<O[K]>;\n} : O;\ntype ConvertArrayData<A> = A extends Array<infer T> ? ConvertData<T>[] : A;\n\nexport const version = '8.0.0';\n","import { createModel as cm } from \"./module/model\";\nimport { CreateModel } from \"./type\";\n\nexport { throwError, isObject } from './utils/helper'\nexport { version,Model, Store, PickModelStore, PickModelData, PickStoreData, StoreData, StoreUnobserve } from \"./type\";\n\nexport const createModel: CreateModel = cm;\n","import {CreateModelInitiator, Model as ModelType} from \"../type\";\nimport {bindThis, isObject, throwError} from \"../utils/helper\";\nimport {BaseStore, checkData, getStoreData} from \"./store\";\n\ninterface ModelOptions {\n  //来自继承\n  sourceExtend?: boolean\n}\n\nfunction createSingleModel<M extends ModelType<any>>(model: M): M {\n  let store;\n\n  return function SingleModel(...args) {\n    return store || (store = new (model as any)(...args));\n  } as unknown as M;\n}\n\nexport function createModel(initiator: CreateModelInitiator<any, any, any>): ModelType<any> {\n  //检查数据\n  if (!isObject(initiator)) {\n    throwError('initiator is not a object');\n  }\n  if (typeof initiator.data !== 'function') {\n    throwError('initiator.data is not a function');\n  }\n  if (initiator.actions && !isObject(initiator.actions)) {\n    throwError('initiator.actions is not a object');\n  }\n  if (initiator.base && !initiator.base.isModel) {\n    throwError('initiator.conn is not a Model');\n  }\n\n  const Base: { new(options?: ModelOptions): BaseStore } = (initiator.base || BaseStore);\n\n  if (initiator.single) {\n    const params = Object.assign({}, initiator, {\n      single: false\n    });\n\n    return createSingleModel(createModel(params));\n  }\n\n  return class Model extends Base {\n    static isModel = true;\n\n    constructor() {\n      super(arguments[0] || {sourceExtend: true});\n\n      const options: ModelOptions = arguments[0];\n      const currentData = initiator.data();\n      const currentActions = initiator.actions || {};\n\n      this.core.baseActions = {...this.actions};\n      this.core.resetData = () => {\n        let baseData = {};\n\n        if (initiator.base) {\n          // @ts-ignore\n          baseData = getStoreData(new Base({\n            sourceExtend: true\n          }));\n        }\n\n        this.core.setData({\n          ...baseData,\n          ...initiator.data()\n        })\n      }\n\n      checkData(currentData);\n      (<any>Object).assign(this, currentData);\n      Object.assign(this.actions, bindThis(currentActions, this));\n\n      if (!(options && options.sourceExtend)) {\n        (<any>Object).seal(this);\n        Object.freeze(this.actions);\n        Object.freeze(this.core);\n      }\n    }\n    }\n}\n"],"names":["isObject","data","Object","prototype","toString","call","throwError","message","name","Error","Observable","constructor","this","addObserver","observer","removeObserver","observes","push","filter","item","notifyObservers","store","forEach","convertData","findData","target","core","isStore","keys","reduce","previousValue","currentValue","Array","isArray","map","getStoreData","checkData","actions","BaseStore","setData","previousData","assign","__observable","observe","resetData","baseActions","version","createModel","initiator","base","isModel","Base","single","model","args","createSingleModel","super","arguments","sourceExtend","options","currentData","currentActions","baseData","thisArg","result","key","bind","bindThis","seal","freeze"],"mappings":"wNAKgBA,EAASC,GACrB,MAAgD,oBAAzCC,OAAOC,UAAUC,SAASC,KAAKJ,YAQ1BK,EAAWC,EAAiBC,EAAO,QAC/C,UAAUC,MAAMD,EAAO,IAAMD,SCbpBG,EAAbC,cACIC,cAAiC,GAEjCC,YAAYC,GACRF,KAAKG,eAAeD,GACpBF,KAAKI,SAASC,KAAKH,GAGvBC,eAAeD,GACXF,KAAKI,SAAWJ,KAAKI,SAASE,OAAOC,GAAQA,IAASL,GAG1DM,gBAAgBC,EAAmBpB,GACd,IAAIW,KAAKI,UAEjBM,QAAQR,GAAYA,EAAST,KAAKgB,EAAOpB,KCb1D,SAASsB,EAAkCF,GAoBzC,OAjBA,SAASG,EAASC,GAChB,OAAIA,GAAUA,EAAOC,MAAQD,EAAOC,KAAKC,QAEhCJ,EAAYE,GACVzB,EAASyB,GACXvB,OAAO0B,KAAKH,GAAQI,OAAO,CAACC,EAAeC,KAChDD,EAAcC,GAAgBP,EAASC,EAAOM,IAEvCD,GACN,IACME,MAAMC,QAAQR,GAChBA,EAAOS,IAAIf,GAAQK,EAASL,IAG9BM,EAGFD,CAnBMW,EAAad,aAsBZe,EAAUnC,GACjBD,EAASC,IACVK,EAAW,wBAGXL,EAAKyB,MACLpB,EAAW,kCAGXL,EAAKoC,SACL/B,EAAW,2CAIH6B,EAAsDd,GAGlE,0IAFiCA,4BAKxBiB,EAAb3B,cACEC,UAA2D,CACzDe,SAAS,EACTY,QAAUtC,IACRmC,EAAUnC,GAEV,MAAMuC,EAAeL,EAAavB,MAC5BV,OAAQuC,OAAO7B,KAAMX,GAC3BW,KAAKc,KAAKgB,aAAatB,gBAAgBR,KAAM4B,IAE/CjB,YAAa,IACJA,EAAYX,MAErB+B,QAAU7B,IACRF,KAAKc,KAAKgB,aAAa7B,YAAYC,GAC5B,IAAMF,KAAKc,KAAKgB,aAAa3B,eAAeD,IAGrD8B,UAAW,OAGXC,YAAa,GAEbH,aAAc,IAAIhC,ICvBToC,MAAAA,EAAU,QCzCVC,WCWGA,EAAYC,SAErBhD,EAASgD,IACZ1C,EAAW,6BAEiB,mBAAnB0C,EAAU/C,MACnBK,EAAW,oCAET0C,EAAUX,UAAYrC,EAASgD,EAAUX,UAC3C/B,EAAW,qCAET0C,EAAUC,OAASD,EAAUC,KAAKC,SACpC5C,EAAW,iCAGb,MAAM6C,EAAoDH,EAAUC,MAAQX,EAE5E,OAAIU,EAAUI,OAzBhB,SAAqDC,GACnD,IAAIhC,EAEJ,mBAA+BiC,GAC7B,OAAOjC,IAAUA,EAAQ,IAAKgC,KAAiBC,KA0BxCC,CAAkBR,EAJV7C,OAAOuC,OAAO,GAAIO,EAAW,CAC1CI,QAAQ,UAML,cAAoBD,EAGzBxC,cACE6C,MAAMC,UAAU,IAAM,CAACC,cAAc,IAErC,MAAMC,EAAwBF,UAAU,GAClCG,EAAcZ,EAAU/C,OACxB4D,EAAiBb,EAAUX,SAAW,GAE5CzB,KAAKc,KAAKmB,iBAAkBjC,KAAKyB,SACjCzB,KAAKc,KAAKkB,UAAY,KACpB,IAAIkB,EAAW,GAEXd,EAAUC,OAEZa,EAAW3B,EAAa,IAAIgB,EAAK,CAC/BO,cAAc,MAIlB9C,KAAKc,KAAKa,aACLuB,EACAd,EAAU/C,UAIjBmC,EAAUwB,GACJ1D,OAAQuC,OAAO7B,KAAMgD,GAC3B1D,OAAOuC,OAAO7B,KAAKyB,iBL7CtBZ,EAAWsC,GACV,MAAMC,EAAS,GAMf,OAJA9D,OAAO0B,KAAKH,GAAQH,QAAS2C,IACxBD,EAAeC,GAAOxC,EAAOwC,GAAKC,KAAKH,KAGrCC,EKsCuBG,CAASN,EAAgBjD,OAE/C+C,GAAWA,EAAQD,eACjBxD,OAAQkE,KAAKxD,MACnBV,OAAOmE,OAAOzD,KAAKyB,SACnBnC,OAAOmE,OAAOzD,KAAKc,mBAjCN"}